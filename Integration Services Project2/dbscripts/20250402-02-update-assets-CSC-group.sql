--DROP TABLE "MIGRATION"."PATCH_20250402_02_ASSETS_CSC_GROUP" IF EXISTS;
--CREATE TABLE "MIGRATION"."PATCH_20250402_02_ASSETS_CSC_GROUP"  (
--		  "ID" BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY (  
--		    START WITH +1  
--		    INCREMENT BY +1  
--		    MINVALUE +1  
--		    MAXVALUE +9223372036854775807  
--		    NO CYCLE  
--		    CACHE 20  
--		    NO ORDER ) , 
--		  "ASSETNUM" VARCHAR(13 OCTETS), 
--		  "STE_CWEQCODE" VARCHAR(31 OCTETS) 
--	)   
--	IN "USERSPACE1"  
--	ORGANIZE BY ROW;

-- COPY THE DATA IN "MIGRATION"."PATCH_20250402_02_ASSETS_CSC_GROUP" FROM ON-PREM
-- MANUAL IMPORT

-- 31.195
-- SELECT COUNT(*) CNT FROM "MIGRATION"."PATCH_20250402_02_ASSETS_CSC_GROUP"

-- CLEAN UP (IN CASE RERUN)
DELETE FROM MAXIMO.TLOAMASSETGRP WHERE STE_MIGRATIONID=20250402 AND STE_MIGRATIONTS=-1;

-- ADD GROUP CSC AS CUSTODIAN
INSERT INTO MAXIMO.TLOAMASSETGRP (
	ASSETNUM, PERSONGROUP, SITEID, ISPRIMARY, TLOAMASSETGRPID,
	STE_MIGRATIONID, STE_MIGRATIONDATE, STE_MIGRATIONTS
)
SELECT A.ASSETNUM, 'CSC' AS PERSONGROUP, 'NEL' AS SITEID, 0 AS ISPRIMARY
	, D.MAX_ID + ROW_NUMBER() OVER (ORDER BY A.ID) AS TLOAMASSETGRPID
	, 20250402 AS STE_MIGRATIONID, ADD_HOURS(CURRENT_TIMESTAMP, 8) AS STE_MIGRATIONDATE
	, -1 AS STE_MIGRATIONTS
FROM MIGRATION.PATCH_20250402_02_ASSETS_CSC_GROUP A
JOIN MAXIMO.ASSET C ON C.ASSETNUM=A.ASSETNUM
LEFT JOIN MAXIMO.TLOAMASSETGRP B ON B.ASSETNUM=A.ASSETNUM AND B.PERSONGROUP='CSC'
JOIN (
	SELECT COALESCE(MAX(TLOAMASSETGRPID),0) AS MAX_ID FROM MAXIMO.TLOAMASSETGRP
) D ON 1=1
WHERE B.TLOAMASSETGRPID IS NULL
;
