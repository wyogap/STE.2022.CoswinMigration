CALL MIGRATION.STE_START_PATCH('20251021-LOCATIONS');

-- BACKUP OLD PATCH TABLE
RENAME TABLE MIGRATION.STE_PATCH_ASSET_LOCATION TO STE_PATCH_ASSET_LOCATION_20251021;

-- UPDATE NEW MAPPING
CREATE TABLE "MIGRATION"."STE_PATCH_ASSET_LOCATION"  (
	  "ID" BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY (  
	    START WITH +1  
	    INCREMENT BY +1  
	    MINVALUE +1  
	    MAXVALUE +9223372036854775807  
	    NO CYCLE  
	    CACHE 20  
	    NO ORDER ) , 
	  "ASSETNUM" VARCHAR(13 OCTETS) , 
	  "STE_CWEQCODE" VARCHAR(31 OCTETS) , 
	  "STE_CSWNASSETID" VARCHAR(40 OCTETS) , 
	  "LOCATION_CODE" VARCHAR(100 OCTETS) , 
	  "LOCATION_20250309" VARCHAR(16 OCTETS) , 
	  "LOCATION" VARCHAR(16 OCTETS) )   
 ORGANIZE BY ROW;

INSERT INTO "MIGRATION"."STE_PATCH_ASSET_LOCATION" (
	ASSETNUM, STE_CWEQCODE, STE_CSWNASSETID, LOCATION_CODE, LOCATION_20250309
)
SELECT 
	ASSETNUM, STE_CWEQCODE, STE_CSWNASSETID, LOCATION_CODE, LOCATION
FROM MIGRATION.STE_PATCH_ASSET_LOCATION_20251021;

MERGE INTO migration.ste_patch_asset_location A
USING (
	SELECT a.id, b.location
	FROM migration.ste_patch_asset_location a
	JOIN maximo.locations b ON b.ste_loccode=a.location_code 
) B ON B.ID=A.ID
WHEN MATCHED THEN
UPDATE SET
	LOCATION=B.LOCATION
;

--SELECT * FROM MAXIMO.LOCATIONS WHERE LOCATION='L100000016779';

-- BACKUP OLD DATA
-- ASSET
CREATE TABLE "MIGRATION"."BAK_20251021_ASSET"  (
	  "ASSETUID" BIGINT , 
	  "ASSETNUM" VARCHAR(13 OCTETS) , 
	  "DESCRIPTION" VARCHAR(200 OCTETS) , 
	  "LOCATION" VARCHAR(16 OCTETS) , 
	  "STE_LOCCODE" VARCHAR(100 OCTETS) , 
	  "NEW_LOCATION" VARCHAR(16 OCTETS),
	  "NEW_LOCATION_CODE" VARCHAR(100 OCTETS)
)   
ORGANIZE BY ROW;

INSERT INTO "MIGRATION"."BAK_20251021_ASSET"(
	ASSETUID, ASSETNUM, DESCRIPTION, LOCATION, STE_LOCCODE, NEW_LOCATION, NEW_LOCATION_CODE
)
SELECT A.ASSETUID, A.ASSETNUM, A.DESCRIPTION, A.LOCATION, C.STE_LOCCODE, B.LOCATION AS NEW_LOCATION, B.LOCATION_CODE AS NEW_LOCATION_CODE
FROM MAXIMO.ASSET A
JOIN MIGRATION.STE_PATCH_ASSET_LOCATION B ON B.ASSETNUM=A.ASSETNUM AND B.LOCATION_20250309=A.LOCATION
JOIN MAXIMO.LOCATIONS C ON C.LOCATION=A.LOCATION
WHERE B.LOCATION_20250309!=B.LOCATION
	--AND A.ASSETNUM IN ('A100000233261', 'A100000000465', 'A100000327306', 'A100000064268', 'A100000071894', 'A100000005121', 'A100000079285', 'A100000079239')
;

-- ASSETHIERARCHY
CREATE TABLE "MIGRATION"."BAK_20251021_ASSETHIERARCHY"  (
	  "ASSETHIERARCHYID" BIGINT , 
	  "PARENT" VARCHAR(13 OCTETS) , 
	  "WONUM" VARCHAR(10 OCTETS) , 
	  "ASSETNUM" VARCHAR(13 OCTETS) , 
	  "LOCATION" VARCHAR(16 OCTETS) , 
	  "STE_LOCCODE" VARCHAR(100 OCTETS) , 
	  "NEW_LOCATION" VARCHAR(16 OCTETS),
	  "NEW_LOCATION_CODE" VARCHAR(100 OCTETS)
)   
ORGANIZE BY ROW;

INSERT INTO "MIGRATION"."BAK_20251021_ASSETHIERARCHY"(
	ASSETHIERARCHYID, PARENT, WONUM, ASSETNUM, LOCATION, STE_LOCCODE, NEW_LOCATION, NEW_LOCATION_CODE
)
SELECT A.ASSETHIERARCHYID, A.PARENT, A.WONUM, A.ASSETNUM, A.LOCATION, C.STE_LOCCODE, B.LOCATION AS NEW_LOCATION, B.LOCATION_CODE AS NEW_LOCATION_CODE
FROM MAXIMO.ASSETHIERARCHY A
JOIN MIGRATION.STE_PATCH_ASSET_LOCATION B ON B.ASSETNUM=A.ASSETNUM AND B.LOCATION_20250309=A.LOCATION
JOIN MAXIMO.LOCATIONS C ON C.LOCATION=A.LOCATION
WHERE B.LOCATION_20250309!=B.LOCATION
	--AND A.ASSETNUM IN ('A100000071893', 'A100000071894', 'A100000079285', 'A100000079239')
;

-- ASSETTRANS
CREATE TABLE "MIGRATION"."BAK_20251021_ASSETTRANS"  (
	  "ASSETTRANSID" BIGINT , 
	  "ASSETNUM" VARCHAR(13 OCTETS) , 
	  "FROMLOC" VARCHAR(16 OCTETS) , 
	  "FROMLOC_CODE" VARCHAR(100 OCTETS) , 
	  "NEW_FROMLOC" VARCHAR(16 OCTETS),
	  "NEW_FROMLOC_CODE" VARCHAR(100 OCTETS),
	  "TOLOC" VARCHAR(16 OCTETS) , 
	  "TOLOC_CODE" VARCHAR(100 OCTETS) , 
	  "NEW_TOLOC" VARCHAR(16 OCTETS),
	  "NEW_TOLOC_CODE" VARCHAR(100 OCTETS)
)   
ORGANIZE BY ROW;

INSERT INTO "MIGRATION"."BAK_20251021_ASSETTRANS"(
	ASSETTRANSID, ASSETNUM, FROMLOC, FROMLOC_CODE, NEW_FROMLOC, NEW_FROMLOC_CODE
)
SELECT A.ASSETTRANSID, A.ASSETNUM, A.FROMLOC, C.STE_LOCCODE AS FROMLOC_CODE, B.LOCATION AS NEW_FROMLOC, B.LOCATION_CODE AS NEW_FROMLOC_CODE
FROM MAXIMO.ASSETTRANS A
JOIN MIGRATION.STE_PATCH_ASSET_LOCATION B ON B.ASSETNUM=A.ASSETNUM AND B.LOCATION_20250309=A.FROMLOC
JOIN MAXIMO.LOCATIONS C ON C.LOCATION=A.FROMLOC
WHERE B.LOCATION_20250309!=B.LOCATION
	--AND A.ASSETNUM IN ('A100000005121', 'A100000079285', 'A100000079239')
;

INSERT INTO "MIGRATION"."BAK_20251021_ASSETTRANS"(
	ASSETTRANSID, ASSETNUM, TOLOC, TOLOC_CODE, NEW_TOLOC, NEW_TOLOC_CODE
)
SELECT A.ASSETTRANSID, A.ASSETNUM, A.TOLOC, C.STE_LOCCODE AS TOLOC_CODE, B.LOCATION AS NEW_TOLOC, B.LOCATION_CODE AS NEW_TOLOC_CODE
FROM MAXIMO.ASSETTRANS A
JOIN MIGRATION.STE_PATCH_ASSET_LOCATION B ON B.ASSETNUM=A.ASSETNUM AND B.LOCATION_20250309=A.TOLOC
JOIN MAXIMO.LOCATIONS C ON C.LOCATION=A.TOLOC
WHERE B.LOCATION_20250309!=B.LOCATION
	--AND A.ASSETNUM IN ('A100000005121', 'A100000079285', 'A100000079239')
;

-- LABTRANS
CREATE TABLE "MIGRATION"."BAK_20251021_LABTRANS"  (
	  "LABTRANSID" BIGINT , 
	  "LABORCODE" VARCHAR(100 OCTETS) , 
	  "REFWO" VARCHAR(10 OCTETS) , 
	  "ASSETNUM" VARCHAR(13 OCTETS) , 
	  "LOCATION" VARCHAR(16 OCTETS) , 
	  "STE_LOCCODE" VARCHAR(100 OCTETS) , 
	  "NEW_LOCATION" VARCHAR(16 OCTETS),
	  "NEW_LOCATION_CODE" VARCHAR(100 OCTETS)
)   
ORGANIZE BY ROW;

INSERT INTO "MIGRATION"."BAK_20251021_LABTRANS"(
	LABTRANSID, LABORCODE, REFWO, ASSETNUM, LOCATION, STE_LOCCODE, NEW_LOCATION, NEW_LOCATION_CODE
)
SELECT A.LABTRANSID, A.LABORCODE, A.REFWO, A.ASSETNUM, A.LOCATION, C.STE_LOCCODE, B.LOCATION AS NEW_LOCATION, B.LOCATION_CODE AS NEW_LOCATION_CODE
FROM MAXIMO.LABTRANS A
JOIN MIGRATION.STE_PATCH_ASSET_LOCATION B ON B.ASSETNUM=A.ASSETNUM AND B.LOCATION_20250309=A.LOCATION
JOIN MAXIMO.LOCATIONS C ON C.LOCATION=A.LOCATION
WHERE B.LOCATION_20250309!=B.LOCATION
	--AND A.ASSETNUM IN ('A100000005121', 'A100000079285', 'A100000079239')
;

-- MATUSETRANS
CREATE TABLE "MIGRATION"."BAK_20251021_MATUSETRANS"  (
	  "MATUSETRANSID" BIGINT , 
	  "ITEMNUM" VARCHAR(30 OCTETS) , 
	  "STORELOC" VARCHAR(16 OCTETS) , 
	  "QUANTITY" DECIMAL(15,2) , 
	  "ASSETNUM" VARCHAR(13 OCTETS) , 
	  "LOCATION" VARCHAR(16 OCTETS) , 
	  "STE_LOCCODE" VARCHAR(100 OCTETS) , 
	  "NEW_LOCATION" VARCHAR(16 OCTETS),
	  "NEW_LOCATION_CODE" VARCHAR(100 OCTETS)
)   
ORGANIZE BY ROW;

INSERT INTO "MIGRATION"."BAK_20251021_MATUSETRANS"(
	MATUSETRANSID, ITEMNUM, STORELOC, QUANTITY, ASSETNUM, LOCATION, STE_LOCCODE, NEW_LOCATION, NEW_LOCATION_CODE
)
SELECT A.MATUSETRANSID, A.ITEMNUM, A.STORELOC, A.QUANTITY, A.ASSETNUM, A.LOCATION, C.STE_LOCCODE, B.LOCATION AS NEW_LOCATION, B.LOCATION_CODE AS NEW_LOCATION_CODE
FROM MAXIMO.MATUSETRANS A
JOIN MIGRATION.STE_PATCH_ASSET_LOCATION B ON B.ASSETNUM=A.ASSETNUM AND B.LOCATION_20250309=A.LOCATION
JOIN MAXIMO.LOCATIONS C ON C.LOCATION=A.LOCATION
WHERE B.LOCATION_20250309!=B.LOCATION
	--AND A.ASSETNUM IN ('A100000074021', 'A100000079285', 'A100000079239')
;

-- MR
CREATE TABLE "MIGRATION"."BAK_20251021_MR"  (
	  "MRID" BIGINT , 
	  "MRNUM" VARCHAR(10 OCTETS) , 
	  "ASSETNUM" VARCHAR(13 OCTETS) , 
	  "LOCATION" VARCHAR(16 OCTETS) , 
	  "STE_LOCCODE" VARCHAR(100 OCTETS) , 
	  "NEW_LOCATION" VARCHAR(16 OCTETS),
	  "NEW_LOCATION_CODE" VARCHAR(100 OCTETS)
)   
ORGANIZE BY ROW;

INSERT INTO "MIGRATION"."BAK_20251021_MR"(
	MRID, MRNUM, ASSETNUM, LOCATION, STE_LOCCODE, NEW_LOCATION, NEW_LOCATION_CODE
)
SELECT A.MRID, A.MRNUM, A.ASSETNUM, A.LOCATION, C.STE_LOCCODE, B.LOCATION AS NEW_LOCATION, B.LOCATION_CODE AS NEW_LOCATION_CODE
FROM MAXIMO.MR A
JOIN MIGRATION.STE_PATCH_ASSET_LOCATION B ON B.ASSETNUM=A.ASSETNUM AND B.LOCATION_20250309=A.LOCATION
JOIN MAXIMO.LOCATIONS C ON C.LOCATION=A.LOCATION
WHERE B.LOCATION_20250309!=B.LOCATION
	--AND A.ASSETNUM IN ('A100000064268')
;

-- MRLINE
CREATE TABLE "MIGRATION"."BAK_20251021_MRLINE"  (
	  "MRLINEID" BIGINT , 
	  "MRNUM" VARCHAR(10 OCTETS) , 
	  "MRLINENUM" INTEGER , 
	  "ASSETNUM" VARCHAR(13 OCTETS) , 
	  "LOCATION" VARCHAR(16 OCTETS) , 
	  "STE_LOCCODE" VARCHAR(100 OCTETS) , 
	  "NEW_LOCATION" VARCHAR(16 OCTETS),
	  "NEW_LOCATION_CODE" VARCHAR(100 OCTETS)
)   
ORGANIZE BY ROW;

INSERT INTO "MIGRATION"."BAK_20251021_MRLINE"(
	MRLINEID, MRNUM, MRLINENUM, ASSETNUM, LOCATION, STE_LOCCODE, NEW_LOCATION, NEW_LOCATION_CODE
)
SELECT A.MRLINEID, A.MRNUM, A.MRLINENUM, A.ASSETNUM, A.LOCATION, C.STE_LOCCODE, B.LOCATION AS NEW_LOCATION, B.LOCATION_CODE AS NEW_LOCATION_CODE
FROM MAXIMO.MRLINE A
JOIN MIGRATION.STE_PATCH_ASSET_LOCATION B ON B.ASSETNUM=A.ASSETNUM AND B.LOCATION_20250309=A.LOCATION
JOIN MAXIMO.LOCATIONS C ON C.LOCATION=A.LOCATION
WHERE B.LOCATION_20250309!=B.LOCATION
	--AND A.ASSETNUM IN ('A100000071893', 'A100000071894', 'A100000079285', 'A100000079239')
;

-- MULTIASSETLOCCI
CREATE TABLE "MIGRATION"."BAK_20251021_MULTIASSETLOCCI"  (
	  "MULTIID" BIGINT , 
	  "RECORDCLASS" VARCHAR(16 OCTETS) , 
	  "RECORDKEY" VARCHAR(10 OCTETS) , 
	  "ROUTE" VARCHAR(20 OCTETS) , 
	  "ROUTESTOP" BIGINT , 
	  "ASSETNUM" VARCHAR(13 OCTETS) , 
	  "LOCATION" VARCHAR(16 OCTETS) , 
	  "STE_LOCCODE" VARCHAR(100 OCTETS) , 
	  "NEW_LOCATION" VARCHAR(16 OCTETS),
	  "NEW_LOCATION_CODE" VARCHAR(100 OCTETS)
)   
ORGANIZE BY ROW;

INSERT INTO "MIGRATION"."BAK_20251021_MULTIASSETLOCCI"(
	MULTIID, RECORDCLASS, RECORDKEY, ROUTE, ROUTESTOP, ASSETNUM, LOCATION, STE_LOCCODE, NEW_LOCATION, NEW_LOCATION_CODE
)
SELECT A.MULTIID, A.RECORDCLASS, A.RECORDKEY, A.ROUTE, A.ROUTESTOP, A.ASSETNUM, A.LOCATION, C.STE_LOCCODE, B.LOCATION AS NEW_LOCATION, B.LOCATION_CODE AS NEW_LOCATION_CODE
FROM MAXIMO.MULTIASSETLOCCI A
JOIN MIGRATION.STE_PATCH_ASSET_LOCATION B ON B.ASSETNUM=A.ASSETNUM AND B.LOCATION_20250309=A.LOCATION
JOIN MAXIMO.LOCATIONS C ON C.LOCATION=A.LOCATION
WHERE B.LOCATION_20250309!=B.LOCATION
	--AND A.ASSETNUM IN ('A100000327306', 'A100000071893', 'A100000071894', 'A100000079285', 'A100000079239')
;

-- PLUSTPMHIST
CREATE TABLE "MIGRATION"."BAK_20251021_PLUSTPMHIST"  (
	  "PLUSTPMHISTID" BIGINT , 
	  "ASSETNUM" VARCHAR(13 OCTETS) , 
	  "LOCATION" VARCHAR(16 OCTETS) , 
	  "STE_LOCCODE" VARCHAR(100 OCTETS) , 
	  "NEW_LOCATION" VARCHAR(16 OCTETS),
	  "NEW_LOCATION_CODE" VARCHAR(100 OCTETS)
)   
ORGANIZE BY ROW;

INSERT INTO "MIGRATION"."BAK_20251021_PLUSTPMHIST"(
	PLUSTPMHISTID, ASSETNUM, LOCATION, STE_LOCCODE, NEW_LOCATION, NEW_LOCATION_CODE
)
SELECT A.PLUSTPMHISTID, A.ASSETNUM, A.LOCATION, C.STE_LOCCODE, B.LOCATION AS NEW_LOCATION, B.LOCATION_CODE AS NEW_LOCATION_CODE
FROM MAXIMO.PLUSTPMHIST A
JOIN MIGRATION.STE_PATCH_ASSET_LOCATION B ON B.ASSETNUM=A.ASSETNUM AND B.LOCATION_20250309=A.LOCATION
JOIN MAXIMO.LOCATIONS C ON C.LOCATION=A.LOCATION
WHERE B.LOCATION_20250309!=B.LOCATION
	--AND A.ASSETNUM IN ('A100000327306', 'A100000064268', 'A100000071894', 'A100000005121', 'A100000079285', 'A100000079239')
;

-- TICKET
CREATE TABLE "MIGRATION"."BAK_20251021_TICKET"  (
	  "TICKETUID" BIGINT , 
	  "TICKETID" VARCHAR(10 OCTETS) , 
	  "DESCRIPTION" VARCHAR(100 OCTETS) , 
	  "ASSETNUM" VARCHAR(13 OCTETS) , 
	  "LOCATION" VARCHAR(16 OCTETS) , 
	  "STE_LOCCODE" VARCHAR(100 OCTETS) , 
	  "NEW_LOCATION" VARCHAR(16 OCTETS),
	  "NEW_LOCATION_CODE" VARCHAR(100 OCTETS)
)   
ORGANIZE BY ROW;

INSERT INTO "MIGRATION"."BAK_20251021_TICKET"(
	TICKETUID, TICKETID, DESCRIPTION, ASSETNUM, LOCATION, STE_LOCCODE, NEW_LOCATION, NEW_LOCATION_CODE
)
SELECT A.TICKETUID, A.TICKETID, A.DESCRIPTION, A.ASSETNUM, A.LOCATION, C.STE_LOCCODE, B.LOCATION AS NEW_LOCATION, B.LOCATION_CODE AS NEW_LOCATION_CODE
FROM MAXIMO.TICKET A
JOIN MIGRATION.STE_PATCH_ASSET_LOCATION B ON B.ASSETNUM=A.ASSETNUM AND B.LOCATION_20250309=A.LOCATION
JOIN MAXIMO.LOCATIONS C ON C.LOCATION=A.LOCATION
WHERE B.LOCATION_20250309!=B.LOCATION
	--AND A.ASSETNUM IN ('A100000000465', 'A100000064268', 'A100000071894', 'A100000005121', 'A100000079285', 'A100000079239')
;

-- WMASSIGNMENT
--SELECT A.ASSETNUM, A.DESCRIPTION, A.LOCATION, C.STE_LOCCODE, B.LOCATION AS NEW_LOCATION, B.LOCATION_CODE AS NEW_LOCATION_CODE
--FROM MAXIMO.WMASSIGNMENT A
--JOIN MIGRATION.STE_PATCH_ASSET_LOCATION B ON B.ASSETNUM=A.ASSETNUM AND B.LOCATION_20250309=A.LOCATION
--JOIN MAXIMO.LOCATIONS C ON C.LOCATION=A.LOCATION
--WHERE B.LOCATION_20250309!=B.LOCATION
--	AND A.ASSETNUM IN ('A100000327306', 'A100000064268', 'A100000071894', 'A100000005121', 'A100000079285', 'A100000079239')
--;

-- WOACTIVITY
--SELECT A.ASSETNUM, A.DESCRIPTION, A.LOCATION, C.STE_LOCCODE, B.LOCATION AS NEW_LOCATION, B.LOCATION_CODE AS NEW_LOCATION_CODE
--FROM MAXIMO.WOACTIVITY A
--JOIN MIGRATION.STE_PATCH_ASSET_LOCATION B ON B.ASSETNUM=A.ASSETNUM AND B.LOCATION_20250309=A.LOCATION
--JOIN MAXIMO.LOCATIONS C ON C.LOCATION=A.LOCATION
--WHERE B.LOCATION_20250309!=B.LOCATION
--	AND A.ASSETNUM IN ('A100000327306', 'A100000064268', 'A100000071894', 'A100000005121', 'A100000079285', 'A100000079239')
--;

-- WORKORDER
CREATE TABLE "MIGRATION"."BAK_20251021_WORKORDER"  (
	  "WORKORDERID" BIGINT , 
	  "WONUM" VARCHAR(10 OCTETS) , 
	  "DESCRIPTION" VARCHAR(100 OCTETS) , 
	  "ASSETNUM" VARCHAR(13 OCTETS) , 
	  "LOCATION" VARCHAR(16 OCTETS) , 
	  "STE_LOCCODE" VARCHAR(100 OCTETS) , 
	  "NEW_LOCATION" VARCHAR(16 OCTETS),
	  "NEW_LOCATION_CODE" VARCHAR(100 OCTETS)
)   
ORGANIZE BY ROW;

INSERT INTO "MIGRATION"."BAK_20251021_WORKORDER"(
	WORKORDERID, WONUM, DESCRIPTION, ASSETNUM, LOCATION, STE_LOCCODE, NEW_LOCATION, NEW_LOCATION_CODE
)
SELECT A.WORKORDERID, A.WONUM, A.DESCRIPTION, A.ASSETNUM, A.LOCATION, C.STE_LOCCODE, B.LOCATION AS NEW_LOCATION, B.LOCATION_CODE AS NEW_LOCATION_CODE
FROM MAXIMO.WORKORDER A
JOIN MIGRATION.STE_PATCH_ASSET_LOCATION B ON B.ASSETNUM=A.ASSETNUM AND B.LOCATION_20250309=A.LOCATION
JOIN MAXIMO.LOCATIONS C ON C.LOCATION=A.LOCATION
WHERE B.LOCATION_20250309!=B.LOCATION
	--AND A.ASSETNUM IN ('A100000327306', 'A100000064268', 'A100000071894', 'A100000005121', 'A100000079285', 'A100000079239')
;

-- PM
CREATE TABLE "MIGRATION"."BAK_20251021_PM"  (
	  "PMUID" BIGINT , 
	  "PMNUM" VARCHAR(16 OCTETS) , 
	  "DESCRIPTION" VARCHAR(100 OCTETS) , 
	  "ASSETNUM" VARCHAR(13 OCTETS) , 
	  "LOCATION" VARCHAR(16 OCTETS) , 
	  "STE_LOCCODE" VARCHAR(100 OCTETS) , 
	  "NEW_LOCATION" VARCHAR(16 OCTETS),
	  "NEW_LOCATION_CODE" VARCHAR(100 OCTETS)
)   
ORGANIZE BY ROW;

INSERT INTO "MIGRATION"."BAK_20251021_PM"(
	PMUID, PMNUM, DESCRIPTION, ASSETNUM, LOCATION, STE_LOCCODE, NEW_LOCATION, NEW_LOCATION_CODE
)
SELECT A.PMUID, A.PMNUM, A.DESCRIPTION, A.ASSETNUM, A.LOCATION, C.STE_LOCCODE, B.LOCATION AS NEW_LOCATION, B.LOCATION_CODE AS NEW_LOCATION_CODE
FROM MAXIMO.PM A
JOIN MIGRATION.STE_PATCH_ASSET_LOCATION B ON B.ASSETNUM=A.ASSETNUM AND B.LOCATION_20250309=A.LOCATION
JOIN MAXIMO.LOCATIONS C ON C.LOCATION=A.LOCATION
WHERE B.LOCATION_20250309!=B.LOCATION
;

-- ROUTE_STOP
CREATE TABLE "MIGRATION"."BAK_20251021_ROUTE_STOP"  (
	  "ROUTE_STOPID" BIGINT , 
	  "ROUTE" VARCHAR(20 OCTETS) , 
	  "ASSETNUM" VARCHAR(13 OCTETS) , 
	  "LOCATION" VARCHAR(16 OCTETS) , 
	  "STE_LOCCODE" VARCHAR(100 OCTETS) , 
	  "NEW_LOCATION" VARCHAR(16 OCTETS),
	  "NEW_LOCATION_CODE" VARCHAR(100 OCTETS)
)   
ORGANIZE BY ROW;

INSERT INTO "MIGRATION"."BAK_20251021_ROUTE_STOP"(
	ROUTE_STOPID, ROUTE, ASSETNUM, LOCATION, STE_LOCCODE, NEW_LOCATION, NEW_LOCATION_CODE
)
SELECT A.ROUTE_STOPID, A.ROUTE, A.ASSETNUM, A.LOCATION, C.STE_LOCCODE, B.LOCATION AS NEW_LOCATION, B.LOCATION_CODE AS NEW_LOCATION_CODE
FROM MAXIMO.ROUTE_STOP A
JOIN MIGRATION.STE_PATCH_ASSET_LOCATION B ON B.ASSETNUM=A.ASSETNUM AND B.LOCATION_20250309=A.LOCATION
JOIN MAXIMO.LOCATIONS C ON C.LOCATION=A.LOCATION
WHERE B.LOCATION_20250309!=B.LOCATION
;

--JPASSETSPLINK
CREATE TABLE "MIGRATION"."BAK_20251021_JPASSETSPLINK"  (
	  "JPASSETSPLINKID" BIGINT , 
	  "ASSETNUM" VARCHAR(13 OCTETS) , 
	  "LOCATION" VARCHAR(16 OCTETS) , 
	  "STE_LOCCODE" VARCHAR(100 OCTETS) , 
	  "NEW_LOCATION" VARCHAR(16 OCTETS),
	  "NEW_LOCATION_CODE" VARCHAR(100 OCTETS)
)   
ORGANIZE BY ROW;

INSERT INTO "MIGRATION"."BAK_20251021_JPASSETSPLINK"(
	JPASSETSPLINKID, ASSETNUM, LOCATION, STE_LOCCODE, NEW_LOCATION, NEW_LOCATION_CODE
)
SELECT A.JPASSETSPLINKID, A.ASSETNUM, A.LOCATION, C.STE_LOCCODE, B.LOCATION AS NEW_LOCATION, B.LOCATION_CODE AS NEW_LOCATION_CODE
FROM MAXIMO.JPASSETSPLINK A
JOIN MIGRATION.STE_PATCH_ASSET_LOCATION B ON B.ASSETNUM=A.ASSETNUM AND B.LOCATION_20250309=A.LOCATION
JOIN MAXIMO.LOCATIONS C ON C.LOCATION=A.LOCATION
WHERE B.LOCATION_20250309!=B.LOCATION
;

-- PLUSTALIASVIEW
--SELECT A.ASSETNUM, A.LOCATION, C.STE_LOCCODE, B.LOCATION AS NEW_LOCATION, B.LOCATION_CODE AS NEW_LOCATION_CODE
--FROM MAXIMO.PLUSTALIASVIEW A
--JOIN MIGRATION.STE_PATCH_ASSET_LOCATION B ON B.ASSETNUM=A.ASSETNUM AND B.LOCATION_20250309=A.LOCATION
--JOIN MAXIMO.LOCATIONS C ON C.LOCATION=A.LOCATION
--WHERE B.LOCATION_20250309!=B.LOCATION
--;

-- UPDATE ACTUAL DATA
-- ASSETS (39.312)
MERGE INTO MAXIMO.ASSET A
USING MIGRATION.BAK_20251021_ASSET B ON B.ASSETUID=A.ASSETUID
WHEN MATCHED THEN
UPDATE SET LOCATION=B.NEW_LOCATION
;

-- ASSETHIERARCHY (2.315)
MERGE INTO MAXIMO.ASSETHIERARCHY A
USING MIGRATION.BAK_20251021_ASSETHIERARCHY B ON B.ASSETHIERARCHYID=A.ASSETHIERARCHYID
WHEN MATCHED THEN
UPDATE SET LOCATION=B.NEW_LOCATION
;

-- ASSETTRANS.FROMLOC (6.238)
MERGE INTO MAXIMO.ASSETTRANS A
USING MIGRATION.BAK_20251021_ASSETTRANS B 
	ON B.ASSETTRANSID=A.ASSETTRANSID AND B.FROMLOC IS NOT NULL
WHEN MATCHED THEN
UPDATE SET FROMLOC=B.NEW_FROMLOC
;

-- ASSETTRANS.TOLOC (45.550)
MERGE INTO MAXIMO.ASSETTRANS A
USING MIGRATION.BAK_20251021_ASSETTRANS B 
	ON B.ASSETTRANSID=A.ASSETTRANSID AND B.TOLOC IS NOT NULL
WHEN MATCHED THEN
UPDATE SET TOLOC=B.NEW_TOLOC
;

-- JPASSETSPLINK
MERGE INTO MAXIMO.JPASSETSPLINK A
USING MIGRATION.BAK_20251021_JPASSETSPLINK B ON B.JPASSETSPLINKID=A.JPASSETSPLINKID
WHEN MATCHED THEN
UPDATE SET LOCATION=B.NEW_LOCATION
;

-- LABTRANS (2.582)
MERGE INTO MAXIMO.LABTRANS A
USING MIGRATION.BAK_20251021_LABTRANS B ON B.LABTRANSID=A.LABTRANSID
WHEN MATCHED THEN
UPDATE SET LOCATION=B.NEW_LOCATION
;

-- MATUSETRANS (6)
MERGE INTO MAXIMO.MATUSETRANS A
USING MIGRATION.BAK_20251021_MATUSETRANS B ON B.MATUSETRANSID=A.MATUSETRANSID
WHEN MATCHED THEN
UPDATE SET LOCATION=B.NEW_LOCATION
;

-- MR (10)
MERGE INTO MAXIMO.MR A
USING MIGRATION.BAK_20251021_MR B ON B.MRID=A.MRID
WHEN MATCHED THEN
UPDATE SET LOCATION=B.NEW_LOCATION
;

-- MRLINE (11)
MERGE INTO MAXIMO.MRLINE A
USING MIGRATION.BAK_20251021_MRLINE B ON B.MRLINEID=A.MRLINEID
WHEN MATCHED THEN
UPDATE SET LOCATION=B.NEW_LOCATION
;

-- MULTIASSETLOCCI (119.149)
MERGE INTO MAXIMO.MULTIASSETLOCCI A
USING MIGRATION.BAK_20251021_MULTIASSETLOCCI B ON B.MULTIID=A.MULTIID
WHEN MATCHED THEN
UPDATE SET LOCATION=B.NEW_LOCATION
;

-- PLUSTPMHIST
MERGE INTO MAXIMO.PLUSTPMHIST A
USING MIGRATION.BAK_20251021_PLUSTPMHIST B ON B.PLUSTPMHISTID=A.PLUSTPMHISTID
WHEN MATCHED THEN
UPDATE SET LOCATION=B.NEW_LOCATION
;

-- PM
MERGE INTO MAXIMO.PM A
USING MIGRATION.BAK_20251021_PM B ON B.PMUID=A.PMUID
WHEN MATCHED THEN
UPDATE SET LOCATION=B.NEW_LOCATION
;

-- ROUTE_STOP
MERGE INTO MAXIMO.ROUTE_STOP A
USING MIGRATION.BAK_20251021_ROUTE_STOP B ON B.ROUTE_STOPID=A.ROUTE_STOPID
WHEN MATCHED THEN
UPDATE SET LOCATION=B.NEW_LOCATION
;

-- TICKET (3.702)
MERGE INTO MAXIMO.TICKET A
USING MIGRATION.BAK_20251021_TICKET B ON B.TICKETID=A.TICKETID
WHEN MATCHED THEN
UPDATE SET LOCATION=B.NEW_LOCATION
;

-- WORKORDER (14.905)
MERGE INTO MAXIMO.WORKORDER A
USING MIGRATION.BAK_20251021_WORKORDER B ON B.WORKORDERID=A.WORKORDERID
WHEN MATCHED THEN
UPDATE SET LOCATION=B.NEW_LOCATION
;

CALL MIGRATION.STE_FINISH_PATCH('20251021-LOCATIONS');