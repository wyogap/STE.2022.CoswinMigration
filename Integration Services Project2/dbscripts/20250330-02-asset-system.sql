--CREATE TABLE "MIGRATION"."PATCH_20250330_02_ASSET_SYSTEM"  (
--		  "ID" BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY (  
--		    START WITH +1  
--		    INCREMENT BY +1  
--		    MINVALUE +1  
--		    MAXVALUE +9223372036854775807  
--		    NO CYCLE  
--		    CACHE 20  
--		    NO ORDER ) , 
--		  "ASSETNUM" VARCHAR(13 OCTETS) , 
--		  "STE_CWEQCODE" VARCHAR(31 OCTETS) , 
--		  "STE_CSWNASSETID" VARCHAR(40 OCTETS) , 
--		  "STE_SYSTEM" VARCHAR(8 OCTETS) 
--	)   
--	IN "USERSPACE1"  
--	ORGANIZE BY ROW;

-- COPY/IMPORT MIGRATION.PATCH_20250330_02_ASSET_SYSTEM FROM ON-PREM (NEL-A) PLATFORM
-- TODO MANUALLY

-- RESET ASSET.STE_SYSTEM AND ASSET.STE_SUBSYSTEM FOR LIST OF ASSETS
UPDATE MAXIMO.ASSET
SET 
	STE_SYSTEM=NULL,
	STE_SUBSYSTEM=NULL
WHERE 
	ASSETUID IN (
		SELECT B.ASSETUID
		FROM MIGRATION.PATCH_20250330_02_ASSET_SYSTEM A
		JOIN MAXIMO.ASSET B ON B.ASSETNUM=A.ASSETNUM
	)
;

-- MISSING ASSET NOT IN LATEST EQP_TOPO
-- ASSETNUM			COSWIN EQCODE		COSWIN ASSETID
-- A100000331005	SCSPGCB2/SKBD202	NEL/SCS/PGC/B2/SKBD202
-- A100000331001	SCSPGCB2/SKBD101	NEL/SCS/PGC/B2/SKBD101

-- UPDATE SR.HISTORYFLAG=1 FOR CLOSED/CANCELLED/REJECTED SR
UPDATE MAXIMO.TICKET SET HISTORYFLAG = 1 WHERE STATUS IN ('CLOSED', 'CANCELLED', 'REJECTED');

-- UPDATE SR ROUTE -> MOVE ROUTE INFO TO STE_ALARM_DESC
MERGE INTO MAXIMO.TICKET A
USING (
	SELECT A.TICKETID, A.ASSETNUM, CAST(RIGHT(A.ASSETNUM, 10) AS BIGINT) AS PK_EQP_TOPO
		, B.ROUTE
	FROM MAXIMO.SR A
	LEFT JOIN MAXIMO.ASSET C ON C.ASSETNUM=A.ASSETNUM
	JOIN MAXIMO.ROUTES B ON B.STE_MIGRATIONID=CAST(RIGHT(A.ASSETNUM, 10) AS BIGINT)
	WHERE A.STE_MIGRATIONID IS NOT NULL 
		-- HAS ASSET (FROM EQP_TOPO)
		AND A.ASSETNUM IS NOT NULL
		-- NOT AN ASSET
		AND C.ASSETUID IS NULL
) B ON B.TICKETID=A.TICKETID
WHEN MATCHED THEN
UPDATE SET
	STE_ALARM_DESC=B.ROUTE,
	ASSETNUM=NULL
;

-- UPDATE LABTRANS.GENAPPRSERVRECEIPT=1 WHEN WO.STATUS='CLOSE'
MERGE INTO MAXIMO.LABTRANS A
USING 
(
	-- 725.628 ROWS
	SELECT A.LABTRANSID
	FROM MAXIMO.LABTRANS A
	JOIN MAXIMO.WORKORDER B ON B.WONUM=A.REFWO
	WHERE B.STATUS='CLOSE'
) B ON B.LABTRANSID=A.LABTRANSID
WHEN MATCHED THEN
UPDATE SET
	GENAPPRSERVRECEIPT=1
;