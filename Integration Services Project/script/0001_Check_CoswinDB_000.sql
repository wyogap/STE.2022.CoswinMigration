-- CREATE TABLE PARAMS
DECLARE
tbl_count number;
sql_stmt long;

BEGIN
    SELECT COUNT(*) INTO tbl_count 
    FROM dba_tables
    WHERE owner = 'COSWIN'
    AND table_name = 'STE_MIGRATION_PARAMS';

    IF(tbl_count <= 0)
    THEN
    	sql_stmt:='
		CREATE TABLE COSWIN.STE_MIGRATION_PARAMS(
			id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
			package_name varchar2(250) NOT NULL,
			parameter_name varchar2(250) NOT NULL,
			parameter_value varchar2(250) NOT NULL,
			created_on DATE DEFAULT CURRENT_TIMESTAMP,
			created_by varchar2(250) NULL,
			modified_on DATE NULL,
			modified_by varchar2(250) NULL
		)';
		EXECUTE IMMEDIATE sql_stmt;
    END IF;
END;

-- UPDATE PARAMS
INSERT INTO COSWIN.STE_MIGRATION_PARAMS
           (package_name
           ,parameter_name
           ,parameter_value
           ,created_by
	   )
     VALUES
           ('0001_Check_CoswinDB'
           ,'version'
           ,'1'
           ,'ssis'
           )
;

-- Views
CREATE VIEW COSWIN.V_STE_EQUIPMENT_METER
AS
SELECT 
	em.PK_EQP_METER 
	,em."TIMESTAMP" 
	,em.S_EQPTOPO_EQPMETER AS PK_EQP_TOPO
	,et.EQ_EQCD 
	,et.EQ_ASSET_ID 
	,et.EQ_DESC 
	,et.EQ_LEVL 
	,et.EQ_CATG 
	,em.S_METER_EQPMETER AS PK_DIR_METER
	,dm.MT_MTID 
	,dm.MT_DESC 
	,dm.MT_CU_RUNT 
	,dm.MT_CU_RUNU 
	,dm.MT_TYPE 
	,dm.MT_MS_UNIT 
	,dm.MT_FREQ 
	,dm.MT_FR_UNIT 
	-- LAST READING
	,ed2.DR_REP_ML
FROM COSWIN.EQP_METER em 
LEFT JOIN COSWIN.EQP_TOPO et ON et.PK_EQP_TOPO = em.S_EQPTOPO_EQPMETER 
LEFT JOIN COSWIN.DIR_METER dm ON dm.PK_DIR_METER = em.S_METER_EQPMETER
LEFT JOIN (
	SELECT ed.EQ_DR_08 
		-- LAST READING
		,ed.DR_REP_ML 
		,ROW_NUMBER() OVER (PARTITION BY ed.EQ_DR_08 ORDER BY DR_REP_DT DESC, DR_REP_TM DESC) rn
	FROM COSWIN.EQP_DEFR ed
) ed2 ON ed2.EQ_DR_08 = et.PK_EQP_TOPO AND ed2.rn = 1
;

-- SELECT * FROM COSWIN.V_STE_EQUIPMENT_METER;

CREATE VIEW COSWIN.V_STE_EQUIPMENT_SERIAL_NO
AS
SELECT 
	es.PK_EQP_SRL 
	,et.PK_EQP_TOPO 
	,et.EQ_EQCD 
	,et.EQ_ASSET_ID 
	,et.EQ_DESC 
	,et.EQ_LEVL 
	,et.EQ_CATG
	,es.ES_SRL_NO 
	,es.ES_REPL_DATE 
FROM COSWIN.EQP_SRL es
LEFT JOIN COSWIN.EQP_TOPO et ON et.PK_EQP_TOPO  = es.EQ_ES_30; 

-- SELECT * FROM V_STE_EQUIPMENT_SERIAL_NO;

CREATE VIEW COSWIN.V_STE_EQUIPMENT_MOVEMENT
AS
SELECT 
	em.PK_EQP_MOVE 
	,em.EM_TYPE 
	,em.EM_DATE 
	,em.EM_TIME 
	,et.PK_EQP_TOPO 
	,et.EQ_EQCD 
	,et.EQ_ASSET_ID 
	,et.EQ_DESC 
	,et.EQ_LEVL 
	,et.EQ_CATG
	,et.EQ_ZONE 
	,et.EQ_UNIT 
	-- PO Number
	,ep.PO_ORD_REF
FROM COSWIN.EQP_MOVE em
LEFT JOIN COSWIN.EQP_TOPO et ON et.EQ_EQCD = em.EM_EQCD
LEFT JOIN COSWIN.EQP_PODP ep ON ep.PO_EQCD = et.EQ_EQCD 
;

-- SELECT * FROM COSWIN.V_STE_EQUIPMENT_MOVEMENT;

CREATE VIEW COSWIN.V_STE_EQUIPMENT_FACILITY
AS
SELECT 
	ff.PK_FM_FACILITY 
	,ff.FM_CODE 
	,ff.FM_DESCRIPTION 
	,ff.FM_RATE 
	,ff.FM_SHARABLE 
	,ff.FM_TIME_UNIT 
	,fi.PK_FM_INSTANCE 
	,fi.FMI_RATE 
	,fi.FMI_SHARABLE 
	,fi.FMI_TIME_UNIT 
	,fi.S_EQP_FMI AS PK_EQP_TOPO
	,et.EQ_EQCD 
	,et.EQ_ASSET_ID 
	,et.EQ_DESC 
	,et.EQ_LEVL 
	,et.EQ_CATG
	,fu.PK_FM_USAGE 
	,fu.FMU_SHARABLE 
	,fu.FMU_STATUS 	--  0–REQUEST, 1–APPROVED, 2–USED
	,fu.FMU_START_DT 
	,fu.FMU_START_TM 
	,fu.FMU_END_DT 
	,fu.FMU_END_TM 
	,fu.FMU_WORKED_TIME 
	,fu.FMU_TIME_UNIT 
	,fu.FMU_ACTUAL_RATE 
	,fu.FMU_PLANNED 
	,fu.FMU_REQUESTED_TIME 
	, ROW_NUMBER() OVER (PARTITION BY S_EQP_FMI ORDER BY PK_FM_USAGE desc, PK_FM_INSTANCE DESC, S_FM_INSTANCE desc) rn
FROM COSWIN.FM_FACILITY ff
LEFT JOIN COSWIN.FM_INSTANCE fi ON ff.PK_FM_FACILITY = fi.S_FM_INSTANCE 
LEFT JOIN COSWIN.EQP_TOPO et ON et.PK_EQP_TOPO = fi.S_EQP_FMI
LEFT JOIN COSWIN.FM_USAGE fu ON fu.S_FMI_USAGE = fi.PK_FM_INSTANCE;

-- SELECT * FROM COSWIN.V_STE_EQUIPMENT_FACILITY;

CREATE VIEW COSWIN.V_STE_TECH_SPEC_ATTRIBUTE
AS
SELECT 
	eh.PK_EQP_HEAD
	, eh.TH_CODE 
	, COALESCE(tl.INDX,0) AS INDX
	, CONCAT(eh.TH_CODE, CONCAT('.', COALESCE(tl.INDX,0))) AS COMPOSITE_ID
	, TRIM(CONCAT(eh.TH_CODE, CONCAT('.', CONCAT(COALESCE(tl.INDX,0), CONCAT(' ', tl.TH_TEXT))))) AS TH_TEXT
	--, tl.TH_TEXT 
FROM COSWIN.EQP_HEAD eh 
LEFT JOIN COSWIN.TH_LINE tl ON tl.COMMONKEY = eh.TH_CODE 
WHERE tl.INDX IS NOT NULL OR tl.TH_TEXT IS NOT NULL
;

-- SELECT * FROM COSWIN.V_STE_TECH_SPEC_ATTRIBUTE;

CREATE VIEW COSWIN.V_STE_EQUIPMENT_SPARE
AS
SELECT 
	et.PK_EQP_TOPO 
	, et.EQ_EQCD 
	, et.EQ_DESC 
	, sp.PK_EQP_SPARE 
	, sp.MS_MINQ 
	, sp.MS_USEQ 
	, sp.MS_DT_LUSE 
	, ds.PK_DIR_STOCK 
	, ds.SL_ITCD -- ITEM.ITEM_CD
	, ds.SL_ITDS -- ITEM.ITEM_SHORT
	, ds.SL_STFL 
	, ds.SL_GRCD -- ITEM.ITEM_GRP
	, ds.SL_UNIT -- ITEM.STOCK_UNITS
	, ds.SL_SNFL 
	, ds.SL_RATE 
	, it.PK_ITEM_ 
	, it.STOCK_UNITS 
	, it.ORDER_UNITS 
	, su.PK_SUPPLIER_ 
	, su.SUPL_CD 
	, su.SUPL_NAME 
FROM COSWIN.EQP_TOPO et 
LEFT JOIN COSWIN.EQP_SPARE sp ON sp.EQ_MS_27 = et.PK_EQP_TOPO 
LEFT JOIN COSWIN.DIR_STOCK ds ON ds.PK_DIR_STOCK = sp.SL_MS_28 
LEFT JOIN COSWIN.ITEM_ it ON it.ITEM_CD = ds.SL_ITCD  
LEFT JOIN COSWIN.SUPPLIER_ su ON su.PK_SUPPLIER_ = it.S_PREF_SUPL 

-- SELECT * FROM COSWIN.V_STE_EQUIPMENT_SPARE

CREATE VIEW COSWIN.V_STE_EQUIPMENT_DEFECT
AS
SELECT 
	et.PK_EQP_TOPO 
	, et.EQ_EQCD 
	, et.EQ_DESC 
	, dr.PK_EQP_DEFR 
	, dr.DR_SYCD	-- symptom
	, sy.DD_TEXT AS SYMPTOM_DS
	, dr.DR_DFCD 	-- defect
	, df.DD_TEXT AS DEFECT_DS
	, dr.DR_CACD 	-- cause
	, ca.DD_TEXT AS CAUSE_DS
	, dr.DR_ACCD 	-- action
	, ac.DD_TEXT AS ACTION_DS
	, dr.DR_DURT 
	, dr.DR_REP_DT 
	, dr.DR_REP_TM 
	, dr.DR_REP_ML 
	, dr.DR_WOID 
	, wo.PK_WIP_WO 
	, wo.WO_LAB_ACOST 
	, wo.WO_MAT_ACOST 
	, wo.WO_MSC_ACOST 
	, wo.WO_REC_ACOST 
FROM COSWIN.EQP_TOPO et 
LEFT JOIN COSWIN.EQP_DEFR dr ON dr.EQ_DR_08 = et.PK_EQP_TOPO 
LEFT JOIN COSWIN.DIR_DEFD sy ON sy.DD_BRCD = dr.DR_SYCD 
LEFT JOIN COSWIN.DIR_DEFD df ON df.DD_BRCD = dr.DR_DFCD 
LEFT JOIN COSWIN.DIR_DEFD ca ON ca.DD_BRCD = dr.DR_CACD 
LEFT JOIN COSWIN.DIR_DEFD ac ON ac.DD_BRCD = dr.DR_ACCD 
LEFT JOIN COSWIN.WIP_WO wo ON wo.WO_WOID = dr.DR_WOID; 

-- SELECT * FROM COSWIN.V_STE_EQUIPMENT_DEFECT;

CREATE VIEW COSWIN.V_STE_EQUIPMENT_PURCHASE_ORDER
AS
SELECT 
	po.PK_EQP_PODP 
	,po.PO_EQCD
	,et.EQ_DESC
	,po.PO_ORD_REF
	,po.PO_ORDT
	,po.PO_ORD_VAL
	,po.CONF_REF
	,po.CONF_DT
	,po.PO_SUP_REF
	,pos.SP_NAME
	,po.PO_MAN_REF
	,pom.MN_NAME
	,po.PO_LES_HIRE
	,po.PO_NEW_OLD
	,po.PO_EXP_DT
	,po.PO_CAP_PROJ
	,po.PO_OWNERSHIP_STATUS
	,po.PO_NOTE1
	,po.PO_NOTE2
	,po.PO_WRR_AMT
	,po.PO_WRR_START_DATE
	,po.PO_WRR_EXPIRY_DATE
	,dr.DOS_TEXT
	,po.DP_COM_DT
	,po.DP_ACQ_VAL
	,po.DP_SAL_VAL
	,po.DP_REP_VAL
	,po.DP_MXL_YR
	,po.DP_PRD_ELAP
	,po.DP_DPTY
	,po.DP_DPRT
	,po.DP_CUR_VAL
	,po.DP_UPT_DT
	,po.DP_IMP_VAL
	,po.DP_IMP_DT
FROM COSWIN.EQP_PODP po
LEFT JOIN COSWIN.EQP_TOPO et ON et.EQ_EQCD = po.PO_EQCD 
LEFT JOIN COSWIN.DIR_MANF pom ON pom.MN_REFR = po.PO_MAN_REF 
LEFT JOIN COSWIN.DIR_SUPP pos ON pos.SP_REFR = po.PO_SUP_REF
LEFT JOIN COSWIN.DOS_RMK dr ON dr.S_EQP_PODP_RMK = po.PK_EQP_PODP;

-- SELECT * FROM COSWIN.V_STE_EQUIPMENT_PURCHASE_ORDER;

--SELECT * FROM (
--SELECT PO_EQCD, count(*) AS cnt FROM V_STE_EQUIPMENT_PURCHASE_ORDER
-- BY PO_EQCD 
--) a WHERE a.cnt>1;

CREATE VIEW COSWIN.V_STE_EQUIPMENT_SUBCONTRACTOR
AS
SELECT 
	ec.PK_EQP_CONT  
	,ec.SC_EQP_CD 
	,et.EQ_DESC
	,ec.SC_CON_REF
	,sub.PK_DIR_SUBC AS PK_DIR_CON
	,sub.SB_NAME AS CON_NAME
	,ec.SC_SUB_REF
	,sub.PK_DIR_SUBC 
	,sub.SB_NAME
	,ec.SB_CON_FL
	,ec.SB_CON_TYPE
	,ec.SC_CON_DT
	,ec.SC_STR_DT
	,ec.SC_END_DT
	,ec.SC_PM_MENH
	,ec.SC_BM_MENH
	,ec.SC_PMNO
	,ec.SC_BMNO
	,ec.SC_CON_VAL
	,ec.SB_MINCON_VAL
	,ec.SB_MAXCON_VAL
FROM COSWIN.EQP_CONT ec
LEFT JOIN COSWIN.EQP_TOPO et ON et.EQ_EQCD = ec.SC_EQP_CD 
-- need to confirm master data for contractor is the same for sub-contractor
LEFT JOIN COSWIN.DIR_SUBC con ON con.SB_REFR = ec.SC_CON_REF 
LEFT JOIN COSWIN.DIR_SUBC sub ON sub.SB_REFR = ec.SC_SUB_REF;

-- SELECT * FROM COSWIN.V_STE_EQUIPMENT_SUBCONTRACTOR;

create VIEW COSWIN.V_STE_EQUIPMENT_REGISTER
AS
SELECT
	et.PK_EQP_TOPO 
	,et.EQ_EQCD
	,et.EQ_ASSET_ID
	,et.EQ_LEVL
	,et.EQ_CATG
	,dc.PK_DIR_CATG AS EQ_CATG_PK
	,dc.CT_DESC AS EQ_CATG_DESC
	,et.EQ_DESC
	,et.EQ_ZONE
	,dz.PK_DIR_ZONE AS EQ_ZONE_PK
	,dz.ZO_DESC AS EQ_ZONE_DESC
	,et.EQ_COSC
	,cc.PK_COSTCENTRE_ AS EQ_COSC_PK
	,cc.CC_NAME AS EQ_COSC_NAME
	,et.EQ_UNIT
	,du.PK_DIR_UNIT AS EQ_UNIT_PK
	,du.UN_DESC  AS EQ_UNIT_DESC
	,et.EQ_WP_TYPE
	,et.EQ_WP_TYPE_FLAG
	,et.EQ_AUTHORITY
	,et.EQ_GEO_TECH
	,et.EQ_BRCD 
	,et.EQ_USER
	,et.EQ_INCH
	,et.EQ_LOCT
	,et.EQ_PHON 
	,et.EQ_TYPE
	,et.EQ_ITEM
	,it.PK_ITEM_ AS EQ_ITEM_PK
	,it.ITEM_SHORT AS EQ_ITEM_SHORT
	,et.EQ_SYCD 
	,et.EQ_PRTY
	,et.EQ_HIST
	,et.EQ_LUDT
	,et.EQ_GEOGRAPH
	-- job remark
	,ja.PK_JOB_ACTV 
	,ja.JA_TEXT 
	-- serial no
	,es.PK_EQP_SRL
	,es.ES_SRL_NO
	,es.ES_REPL_DATE
	-- facility (repair location in MAXIMO?)
	,ff.PK_FM_FACILITY 
	,ff.FM_CODE 
	,ff.FM_DESCRIPTION 
	-- tech specification
	,th.PK_EQP_TECH 
	,th.TS_MODL 
	,th.TS_MANF 
	,th.TS_SUPP 
	,th.TS_YR_MINL 
	-- purchase order
	,po.PK_EQP_PODP 
	,po.PO_ORD_REF 	-- PO NUMBER
	,po.PO_ORDT		-- ORDER DATE
	,po.PO_ORD_VAL 	-- total base cost
	,po.PO_MAN_REF 
	,po.PO_SUP_REF 
	-- purchase order (Warranty)
	,po.PO_EXP_DT 	-- Est. END OF LIFE
	,po.PO_WRR_AMT 
	,po.PO_WRR_START_DATE 
	,po.PO_WRR_EXPIRY_DATE 
	-- purchase order (Depreciation)
	,po.DP_COM_DT 	-- Install DATE/Commission DATE
	,po.DP_ACQ_VAL 	-- Purchase PRICE
	,po.DP_REP_VAL 	-- REPLACE COST
	,po.DP_MXL_YR 	-- Expected Life
	,po.DP_CUR_VAL 	-- CURRENT value
	-- manufacturer (from po or tech specification)
	,COALESCE(pom.PK_DIR_MANF, dm.PK_DIR_MANF) AS PK_DIR_MANF
	,COALESCE(pom.MN_NAME, dm.MN_NAME) AS MN_NAME
	-- supplier (from po or tech specification)
	,COALESCE(pos.PK_DIR_SUPP, ds.PK_DIR_SUPP) AS PK_DIR_SUPP 
	,COALESCE(pos.SP_NAME, ds.SP_NAME) AS SP_NAME 
	-- equipment group 
	-- ,gr.PK_EQP_TOPO AS PK_EQP_GRP
	-- ,gr.EQ_EQCD AS EQ_GRCD
	-- ,gr.EQ_LEVL AS GR_LEVL
	-- ,gr.EQ_DESC AS GR_DESC
	-- ,eg.GR_EQPR 
	-- parent 
	,pr.PK_EQP_TOPO AS PK_EQP_PR
	,pr.EQ_EQCD as EQ_PRCD
	,pr.EQ_ASSET_ID AS PR_ASSET_ID
	,pr.EQ_LEVL AS PR_LEVL
	,pr.EQ_DESC AS PR_DESC
	-- defect
	,ed1.DR_DURT
FROM COSWIN.EQP_TOPO et
LEFT JOIN COSWIN.DIR_CATG dc ON dc.CT_CATG = et.EQ_CATG
LEFT JOIN COSWIN.DIR_ZONE dz ON dz.ZO_ZONE = et.EQ_ZONE
LEFT JOIN COSWIN.COSTCENTRE_ cc ON cc.CC_CD = et.EQ_COSC 
LEFT JOIN COSWIN.DIR_UNIT du ON du.UN_UNIT = et.EQ_UNIT 
LEFT JOIN COSWIN.ITEM_ it ON it.ITEM_CD = et.EQ_ITEM  
LEFT JOIN COSWIN.JOB_ACTV ja ON ja.EQ_JA_24 = et.PK_EQP_TOPO 
LEFT JOIN (
	SELECT es.PK_EQP_SRL, es."TIMESTAMP", es.EQ_ES_30, es.IDX_EQ_ES_30, es.ES_SRL_NO, es.ES_REPL_DATE
		-- get the latest serial no for each equipment
		, ROW_NUMBER() OVER (PARTITION BY EQ_ES_30 ORDER BY ES_REPL_DATE desc) rn
	FROM COSWIN.EQP_SRL es 
) es ON es.EQ_ES_30 = et.PK_EQP_TOPO AND es.rn = 1
LEFT JOIN (
	SELECT 
		fi.PK_FM_INSTANCE 
		,fi.S_FM_INSTANCE AS PK_FM_FACILITY
		,ff.FM_CODE 
		,ff.FM_DESCRIPTION 
		,fi.S_EQP_FMI AS PK_EQP_TOPO
		-- get the latest facility instance for each equipment
		, ROW_NUMBER() OVER (PARTITION BY S_EQP_FMI ORDER BY PK_FM_INSTANCE desc) rn
	FROM COSWIN.FM_INSTANCE fi 
	LEFT JOIN COSWIN.FM_FACILITY ff ON ff.PK_FM_FACILITY = fi.S_FM_INSTANCE 
	WHERE fi.S_EQP_FMI IS NOT null
) ff ON ff.PK_EQP_TOPO = et.PK_EQP_TOPO AND ff.rn=1
LEFT JOIN COSWIN.EQP_TECH th ON th.TS_EQCD = et.EQ_EQCD 
LEFT JOIN COSWIN.DIR_MANF dm ON dm.MN_REFR = th.TS_MANF 
LEFT JOIN COSWIN.DIR_SUPP ds ON ds.SP_REFR = th.TS_SUPP
LEFT JOIN COSWIN.EQP_PODP po ON po.PO_EQCD = et.EQ_EQCD 
LEFT JOIN COSWIN.DIR_MANF pom ON pom.MN_REFR = po.PO_MAN_REF 
LEFT JOIN COSWIN.DIR_SUPP pos ON pos.SP_REFR = po.PO_SUP_REF
--LEFT JOIN COSWIN.EQP_GROUP eg ON eg.EQ_GR_15 = et.PK_EQP_TOPO 
--LEFT JOIN COSWIN.EQP_TOPO gr ON gr.EQ_GRFL = 71 and gr.PK_EQP_TOPO = eg.EQ_GR_16 
LEFT JOIN COSWIN.EQP_TOPO pr ON et.EQ_LEVL > 1 and pr.EQ_EQCD = et.EQ_PRCD 
LEFT JOIN (
	SELECT ed.EQ_DR_08 
		-- TOTAL DOWNTIME
		,SUM(DR_DURT) AS DR_DURT
	FROM COSWIN.EQP_DEFR ed
	GROUP BY ed.EQ_DR_08
) ed1 ON ed1.EQ_DR_08 = et.PK_EQP_TOPO 
WHERE et.EQ_GRFL != 71 
;

-- SELECT * FROM COSWIN.V_STE_EQUIPMENT_REGISTER WHERE eq_asset_id IS null;

CREATE VIEW COSWIN.V_STE_EQUIPMENT_GROUP
AS
SELECT 
	et.PK_EQP_TOPO 
	,et.EQ_EQCD
	,et.EQ_ZONE
	,et.EQ_DESC
	,et.EQ_CATG
	,et.EQ_UNIT
	,et.EQ_WP_TYPE
	,et.EQ_AUTHORITY
	,et.EQ_BRCD
	,et.EQ_INCH
	,et.EQ_COSC
	,et.EQ_CALLOC
	,et.EQ_PRTY
	,et.EQ_HIST
FROM COSWIN.EQP_TOPO et 
WHERE et.EQ_GRFL = 71;

-- SELECT * FROM COSWIN.V_STE_EQUIPMENT_GROUP;

CREATE VIEW COSWIN.V_STE_EQUIPMENT_MANUAL
AS
SELECT
	ed.PK_EQP_DRAW 
	,et.PK_EQP_TOPO 
	,et.EQ_EQCD
	,et.EQ_DESC
	,ed.DM_DRWN
	,ed.DM_PRP_DT
	,ed.DM_VER
	,ed.DM_LOCT
FROM COSWIN.EQP_DRAW ed 
LEFT JOIN COSWIN.EQP_TOPO et ON ed.EQ_DM_04 = et.PK_EQP_TOPO;

-- SELECT * FROM V_STE_EQUIPMENT_MANUAL;

CREATE VIEW COSWIN.V_STE_EQUIPMENT_DOSDONTS
AS
SELECT
	dos.PK_EQP_DOS  
	,et.PK_EQP_TOPO 
	,et.EQ_EQCD
	,et.EQ_DESC
	,dos.DO_TYPE 
	,dos.DO_CODE 
	,def.PK_DIR_DEFD 
	,def.DD_TEXT 
FROM COSWIN.EQP_DOS dos 
LEFT JOIN COSWIN.EQP_TOPO et ON dos.EQ_DO_07 = et.PK_EQP_TOPO 
LEFT JOIN COSWIN.DIR_DEFD def ON def.DD_BRCD = dos.DO_CODE; 

-- SELECT * FROM COSWIN.V_STE_EQUIPMENT_DOSDONTS;

CREATE VIEW COSWIN.V_STE_WORKORDER
AS
SELECT 
	ww.PK_WIP_WO
	, ww.WO_WOID
	-- can be an equipment/asset or a group of equipments
	, ww.WO_EQCD
	, et.PK_EQP_TOPO 
	, et.EQ_ASSET_ID 
	, et.EQ_DESC 
	, ww.WO_UNIT
	, ww.WO_JOB_ID
	, ww.WO_REP_BY
	, ww.WO_REQNO 
	, ww.WO_DURN
	, ww.WO_SCH_DT, ww.WO_SCHDD, ww.WO_SCHWK, ww.WO_SCHYR
	, ww.WO_REP_DT, ww.WO_REP_TM
	, ww.WO_STR_DT, ww.WO_STR_TM
	, ww.WO_FIN_DT, ww.WO_FIN_TM, ww.WO_FINDD, ww.WO_FINWK, ww.WO_FINYR
	, ww.WO_LUP_DT, ww.WO_MAN_DT, ww.WO_MAN_TM
	, ww.WO_LAB_SCOST, ww.WO_MAT_SCOST
	, ww.WO_LAB_ACOST, ww.WO_MAT_ACOST, ww.WO_MSC_ACOST, ww.WO_REC_ACOST
	, ww.WO_PLN_HRS, ww.WO_ACT_HRS
	, ww.WO_EQP_SRL
	, ww.WO_NUMBER1, ww.WO_NUMBER2, ww.WO_DATE1, ww.WO_DATE2
	, ww.WO_PRIORITY
	, ww.WO_TARGET_DT
	, ww.WO_WORK_PERMIT, ww.WO_SAFETY_INVOLVED
	, ww.WO_FM_ACOST, ww.WO_FM_SCOST
	, ww.WO_CRITICALITY, ww.WO_ALLOCATIONSTATUS
	, ww.WO_SYCD 
	-- defect
	, dr.PK_EQP_DEFR 
	, dr.DR_SYCD	-- symptom
	, sy.DD_TEXT AS SYMPTOM_DS
	, dr.DR_DFCD 	-- defect
	, df.DD_TEXT AS DEFECT_DS
	, dr.DR_CACD 	-- cause
	, ca.DD_TEXT AS CAUSE_DS
	, dr.DR_ACCD 	-- action
	, ac.DD_TEXT AS ACTION_DS
	, dr.DR_DURT 
FROM COSWIN.WIP_WO ww
LEFT JOIN COSWIN.EQP_TOPO et ON et.EQ_EQCD = ww.WO_EQCD 
LEFT JOIN COSWIN.EQP_DEFR dr ON dr.DR_WOID = ww.WO_WOID 
LEFT JOIN COSWIN.DIR_DEFD sy ON sy.DD_BRCD = dr.DR_SYCD 
LEFT JOIN COSWIN.DIR_DEFD df ON df.DD_BRCD = dr.DR_DFCD 
LEFT JOIN COSWIN.DIR_DEFD ca ON ca.DD_BRCD = dr.DR_CACD 
LEFT JOIN COSWIN.DIR_DEFD ac ON ac.DD_BRCD = dr.DR_ACCD 
;

-- SELECT * FROM V_STE_WORKORDER;

CREATE VIEW COSWIN.V_STE_SUPPLIER
AS
	SELECT 
		PK_SUPPLIER_
		, SUPL_CD 
		, SUPL_NAME 
		, COM_CONTACT 
		, COM_NO 
		, COM_FAX_NO
		, 'SUPPLIER_' AS SOURCE_TABLE
		, CONCAT('SUPPLIER_/', PK_SUPPLIER_) COMPOSITE_ID
	FROM COSWIN.SUPPLIER_
	
	UNION ALL
	
	SELECT 
		PK_DIR_SUPP AS PK_SUPPLIER_
		, SP_REFR AS SUPL_CD
		, SP_NAME AS SUPL_NAME
		, SP_COMM_NAME AS COM_CONTACT
		, SP_COMM_PHON AS COM_NO
		, SP_COMM_FAXN AS COM_FAX_NO
		, 'DIR_SUPP' AS SOURCE_TABLE
		, CONCAT('DIR_SUPP/', PK_DIR_SUPP) COMPOSITE_ID
	FROM COSWIN.DIR_SUPP ds 
	LEFT JOIN COSWIN.SUPPLIER_ s ON s.SUPL_CD = ds.SP_REFR
	WHERE s.SUPL_CD IS NULL
;

-- SELECT * FROM COSWIN.V_STE_SUPPLIER;

CREATE VIEW COSWIN.V_STE_PURCHASE_ORDER
AS
SELECT 
	po.PK_PORDER_
	, po.DT_PORDER
	, po.TM_PORDER
	, po.PO_REF
	, po.PO_TYPE
	, po.PO_STATUS
	, po.PO_AUT_BY
	, wu1.USER_ID AS PO_AUT_USER_ID
	, wu1.USR_AUTHORITY AS PO_AUT_AUTHORITY
	, po.PO_CURR_CD
	, po.PO_VALUE
	, po.DR_TXT1, DR_TXT2
	, po.PO_PREQ_REF
	, pr.PK_PREQUEST 
	, pr.PR_REF 
	, pr.DT_PREQUEST 
	, pr.TM_PREQUEST 
	, pr.PR_TYPE 
	, pr.PR_STATUS 
	, pr.PR_EST_VAL 
	, pr.PR_REQ_BY 
	, wu2.USER_ID AS PR_REQ_USER_ID
	, wu2.USR_AUTHORITY AS PR_REQ_AUTHORITY
	, po.PO_PAY_DET
FROM COSWIN.PORDER_ po
LEFT JOIN PREQUEST pr ON pr.PR_REF = po.PO_PREQ_REF
LEFT JOIN WIN_USERS wu1 ON wu1.USR_SIGNATURE = po.PO_AUT_BY 
LEFT JOIN WIN_USERS wu2 ON wu2.USR_SIGNATURE = pr.PR_REQ_BY
;

-- SELECT * FROM COSWIN.V_STE_PURCHASE_ORDER;

CREATE VIEW COSWIN.V_STE_USERS
AS
SELECT 
	wu.PK_WIN_USERS 
	, wu.USER_ID 
	, wu.USR_AUTHORITY 
	, wu.USR_SIGNATURE 
	, gu.PK_GROUP_USERS 
	, gu.GROUP_ID 
	, gu.GRP_AUTHORITY 
FROM COSWIN.WIN_USERS wu 
LEFT JOIN COSWIN.GROUP_USERS gu ON gu.PK_GROUP_USERS = wu.WIN_GRP_USR 
;

-- SELECT * FROM COSWIN.V_STE_USERS;

CREATE VIEW COSWIN.V_STE_METER
AS
SELECT 
	PK_DIR_METER
	, MT_MTID
	, MT_DESC
	, MT_CU_RUNT
	, MT_CU_RUNU
	, MT_TYPE
	, MT_MS_UNIT
	, MT_FREQ
	, MT_FR_UNIT
FROM COSWIN.DIR_METER;

-- SELECT * FROM COSWIN.V_STE_METER;

CREATE VIEW COSWIN.V_STE_ASSETUSER
AS
SELECT 
	a.PK_EQP_TOPO, a.USER_ID
	, MAX(a.EQ_ASSET_ID) AS EQ_ASSET_ID
	, MAX(a.custodian) AS CUSTODIAN 
FROM 
(
	SELECT et2.PK_EQP_TOPO, et2.EQ_ASSET_ID, wu1.USER_ID, 0 AS custodian FROM coswin.EQP_TOPO et2 
	LEFT JOIN COSWIN.WIN_USERS wu1 ON wu1.USER_ID = et2.EQ_USER 
	WHERE wu1.USER_ID IS NOT NULL
	
	UNION 
	
	SELECT et2.PK_EQP_TOPO, et2.EQ_ASSET_ID, wu1.USER_ID, 1 AS custodian FROM coswin.EQP_TOPO et2 
	LEFT JOIN COSWIN.WIN_USERS wu1 ON wu1.USER_ID = et2.EQ_INCH  
	WHERE wu1.USER_ID IS NOT NULL
) a 
GROUP BY a.PK_EQP_TOPO, a.USER_ID
;

-- SELECT * FROM COSWIN.V_STE_ASSETUSER;

CREATE VIEW COSWIN.V_STE_EQUIPMENT_SPECS
AS
SELECT
	et.PK_EQP_TOPO 
	,et.EQ_EQCD
	,et.EQ_ASSET_ID
	,et.EQ_CATG
	,et.EQ_DESC
	,et.EQ_ZONE
	-- tech specification
	,th.PK_EQP_TECH 
	,th.TS_MODL
	,th.TS_MANF
	,th.TS_SUPP
	,th.TS_CAPC
	,th.TS_RATG
	,th.TS_MTID
	,mt.MT_MS_UNIT
	,th.TS_MTBFV
	,th.TS_MTBFU
	,th.TS_MTTRV
	,th.TS_MTTRU
	,th.TS_REGISTRATION_NO
	,th.TS_COUNTRY
	,th.TS_SLNO
	,th.TS_MM_MANF
	,th.TS_YY_MANF
	,th.TS_ARRWK
	,th.TS_ARRYR
	,th.TS_YR_MINL
	,th.TS_MN_MINL
	,th.TS_ML_MINL
	,th.TS_YR_MAXL
	,th.TS_MN_MAXL
	,th.TS_ML_MAXL
FROM COSWIN.EQP_TOPO et
LEFT JOIN COSWIN.EQP_TECH th ON th.TS_EQCD = et.EQ_EQCD 
LEFT JOIN COSWIN.DIR_METER mt ON mt.MT_MTID = th.TS_MTID 
--WHERE 
--	th.TS_MODL IS NOT null
--	OR th.TS_MANF IS NOT null
--	OR th.TS_SUPP IS NOT null
--	OR 
--	th.TS_CAPC IS NOT null
--	OR th.TS_RATG IS NOT null
--	OR th.TS_MTID IS NOT null
--	OR th.TS_MTBFV > 0
--	OR th.TS_MTBFU IS NOT null
--	OR th.TS_MTTRV > 0
--	OR th.TS_MTTRU IS NOT null
--	OR th.TS_REGISTRATION_NO IS NOT null
--	OR th.TS_COUNTRY IS NOT null
--	--OR th.TS_SLNO IS NOT null
--	OR th.TS_MM_MANF > 0
--	OR th.TS_YY_MANF > 0
--	OR th.TS_ARRWK > 0
--	OR th.TS_ARRYR > 0
--	OR th.TS_YR_MINL > 0
--	OR th.TS_MN_MINL > 0
--	OR th.TS_ML_MINL > 0
--	OR th.TS_YR_MAXL > 0
--	OR th.TS_MN_MAXL > 0
--	OR th.TS_ML_MAXL > 0
;

-- SELECT * FROM COSWIN.V_STE_EQUIPMENT_SPECS;
